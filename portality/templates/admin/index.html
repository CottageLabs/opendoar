{% extends "base.html" %}

{% block content %}

<div id="facetview"></div>

{% endblock %}

{% block extra_js_bottom %}

<script type="text/javascript">
jQuery(document).ready(function($) {

    var record_url = '{{app.config["OARR_API_BASE_URL"]}}/query?';
    var record_datatype = 'JSONP';
    var record_resdisplay = [];
    
    var record_facets = [
        {'field': 'admin.opendoar.in_opendoar.exact', 'display': 'In OpenDOAR?'},
        {'field': 'register.operational_status.exact', 'display': 'Operational Status'}
    ];
    
    function discoveryRecordView(index) {
        var options = $("#facetview").facetview.options
        var record = options.data['records'][index];
        var result = '<p style="padding:top:10px;padding-left:10px;">';

        // get all of the bits out of the object that we want to display
        result += '<a href="/admin/record/' + record.id + '">' + record.register.metadata[0].record.name + '</a>';
        
        result += "</p>";
        return result;
    }


    var opts = {
        search_url: record_url,
        datatype: record_datatype,
        facets: record_facets,
        searchbox_shade: "#fff",
        result_display: record_resdisplay,
        sharesave_link: false,
        paging: {
            size: 100
        },
        display_images: false,
        buildrecord: discoveryRecordView,
        search_sortby: [
            {"field": "created_date", "display": "Record created date"},
            {"field": "last_updated", "display": "Record last updated date"}
        ]
    };

    $('#facetview').facetview(opts);

    var controls = '<div class="well" id="controls" style="position:fixed;margin-top:10px;">';
    controls += '<p>There are {{stats.out}} records not in OpenDOAR. {% if stats.out != 0 %}View: <input type="checkbox" id="show_not_in" class="checkers">{% endif %}</p>';
    controls += '<p>There are {{stats.unviewed}} in OpenDOAR requiring review. {% if stats.unviewed != 0 %}View: <input type="checkbox" class="checkers" id="show_unviewed">{% endif %}</p>';
    controls += '<p>There are {{stats.updaterequest}} update requests. {% if stats.updaterequest != 0 %}View: <input type="checkbox" class="checkers" id="show_updaterequest">{% endif %}</p>';
    controls += '<p><br><a class="btn" style="width:150px;" href="/admin/record/new">Create new record</a> ';
    controls += '<a class="btn" style="width:150px;" href="/account">Manage accounts</a></p>';
    controls += '</div>';

    $('#facetview_rightcol').siblings('.span3').removeClass('span3').addClass('span4').prepend(controls);
    $('#facetview_rightcol').removeClass('span9').addClass('span7').css({"float":"right","min-height":"600px"});
    $('#facetview_filters').hide();
    $('.facetview_metadata').prependTo('#controls').css({"margin-top":"-20px"});
    $('.facetview_search_options_container').prependTo('#controls');
    $('.facetview_freetext').prependTo('#controls');
    $('.facetview_learnmore').hide();
    $('.facetview_orderby').css({"width":"200px"});
    $('#controls').prepend('<p>Welcome to admin. Search for records here, <br>or view by task, or choose management tasks. <br>Click record names on the right to edit.</p>');

    var filteroptions = function(event) {
        event.preventDefault();
        $('#facetview').facetview.options.predefined_filters = {};
        $('#facetview').facetview.options.predefined_should = {};
        var thisone = $(this).attr('id');
        $('.checkers').each(function() {
            if ( $(this).attr('id') != thisone ) {
                $(this).prop('checked',false);
            }
        });
        if ( $("#show_not_in").is(':checked') ) {
            $('#facetview').facetview.options.predefined_should.notin = {"term": {"admin.opendoar.in_opendoar":false}}
            $('#facetview').facetview.options.predefined_should.missing = {"missing": {"field": "admin.opendoar.in_opendoar"}};
        }
        if ( $("#show_unviewed").is(':checked') ) {
            $('#facetview').facetview.options.predefined_filters.in = {"term": {"admin.opendoar.in_opendoar":true}}
            $('#facetview').facetview.options.predefined_filters.saved = {'constant_score': {'filter': {'exists': {'field': 'admin.opendoar.last_saved'}}}}
            $('#facetview').facetview.options.predefined_filters.notviewed = {"script": { "script" : "unviewed"}}
        }
        if ( $("#show_updaterequest").is(':checked') ) {
            $('#facetview').facetview.options.predefined_filters.updaterequest = {
                "constant_score": {
                    "filter": {
                        "exists": {
                            "field": "admin.opendoar.updaterequest"
                        }
                    }
                }
            }
        }
        $('.facetview_freetext').trigger('keyup');
    }
    $("#show_not_in").bind('change',filteroptions);
    $("#show_unviewed").bind('change',filteroptions);
    $("#show_updaterequest").bind('change',filteroptions);

});

</script>

{% endblock %}
