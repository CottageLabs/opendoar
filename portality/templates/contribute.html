{% extends "base.html" %}

{% block content %}

<style>
label{
    width:200px;
    display:inline-block;
}
.add-row {
    width:35px;
}
.delete-row {
    width:35px;
    display:inline;
    margin:0 5px 0 0;
}
.banner{
    margin-top:50px;
}
#dupwarning{
    display:none;
}
</style>






<div class="hero-unit odh">
    {% if record.id %}
    <h1>{{record.register.metadata[0].record.name}}</h1>
    {% else %}
    <h1>Add a repository to OpenDOAR</h1>
    {% endif %}
    {% if current_user.is_super %}
    <p id="sumeta" style="color:white;"><br>Operational status: 
    <input type="text" name="register__operational_status" class="acs" style="margin-right:50px;">
    In OpenDOAR: 
    <input type="checkbox" name="admin__opendoar__in_opendoar" 
    {% if record.id %}{% if record.admin.opendoar.in_opendoar %}checked="checked"{% endif %}{% endif %}>
    </p>
    {% endif %}
</div>



<form id="detect" method="GET" action="" style="display:none;">
<input style="font-size:40px;width:99%;height:80px;line-height:40px;margin-top:20px;" type="text" name="url" id="url" placeholder="http:// repository url here">
<input type="submit" class="btn btn-info" style="width:100%;font-size:30px;line-height:30px;height:120px;margin-top:30px;" value="Enter a repository URL above and click here to begin">

{% if not current_user.is_super %}
<p><br><br>Alternatively, if you'd just like to see what we can detect about your repository and how that default information would look as a record in OpenDoar, 
<br>then <a href="/detect">try out our repository metadata autodetection tool</a>.</p>
{% endif %}

</form>



<form id="form" action="" method="post">

<p style="color:red;">NOTE: for fields marked (s) * it is possible to provide multiple comma-separated values. 
If you wish to provide a value that contains a comma, wrap it in double quotation marks, e.g. "books, videos".</p>

<!-- record metadata across all languages -->
{% for metadata in record.register.metadata %}

{% if metadata.default %}

<div id="metadata_default">

<h1>
    {{metadata.lang}}
    <input type="hidden" name="register__metadata__default" value="{{metadata.default}}">
    {% if metadata.default %}<small>DEFAULT</small>{% else %}<a class="makdefault" href="#">make default</a>{% endif %}
</h1>

<div class="row-fluid">

    <div class="span6">

        <p><label for="register__metadata__record__url">URL</label>
        <input id="url" type="text" name="register__metadata__record__url" value="{{metadata.record.url}}"></p>
        
        <p id="dupwarning" style="color:red;">
        NOTE: there is already an OpenDOAR record with this URL. <br>
        <a id="dupid" target="_blank" href="/repository/">Click here to review it</a> before creating a new record.</p>
        </p>

        <p><label for="register__metadata__record__name">Name</label>
        <input type="text" name="register__metadata__record__name" value="{{metadata.record.name}}"></p>

        <p><label for="register__metadata__record__acronym">Acronym</label>
        <input type="text" name="register__metadata__record__acronym" value="{{metadata.record.acronym}}"></p>

        <p><label for="register__metadata__record__established_date">Established date</label>
        <input type="text" name="register__metadata__record__established_date" class="datepicker" value="{{metadata.record.established_date}}"></p>

        <p><label for="register__metadata__record__twitter">Twitter</label>
        <input type="text" name="register__metadata__record__twitter" value="{{metadata.record.twitter}}"></p>
<!--
        <p><label for="register__metadata__record__country">Country</label>
        <input type="text" name="register__metadata__record__country" value="{{metadata.record.country}}" class="acs"></p>
-->
        <p><label for="register__metadata__record__country_code">Country code</label>
        <input type="text" name="register__metadata__record__country_code" value="{{metadata.record.country_code}}" class="acs"></p>
<!--
        <p><label for="register__metadata__record__continent">Continent</label>
        <input type="text" name="register__metadata__record__continent" value="{{metadata.record.continent}}" class="acs"></p>
-->
        <p><label for="register__metadata__record__continent_code">Continent code</label>
        <input type="text" name="register__metadata__record__continent_code" value="{{metadata.record.continent_code}}" class="acs"></p>

    </div>
    
    <div class="span6">

        <p><label for="register__metadata__record__description">Description</label>
        <textarea name="register__metadata__record__description" style="height:110px;">{{metadata.record.description}}</textarea></p>
<!--        
        <p><label for="register__metadata__record__language">Language <span style="color:red;">(s) *</span></label>
        <input type="text" name="register__metadata__record__language" value="{{', '.join(metadata.record.language)}}" class="ac"></p>
-->
        <p><label for="register__metadata__record__language_code">Language code <span style="color:red;">(s) *</span></label>
        <input type="text" name="register__metadata__record__language_code" value="{{', '.join(metadata.record.language_code)}}" class="ac"></p>
        
        <p><label for="register__metadata__record__repository_type">Repository type <span style="color:red;">(s) *</span></label>
        <input type="text" name="register__metadata__record__repository_type" value="{{', '.join(metadata.record.repository_type)}}" class="ac"></p>
    
        <p><label for="register__metadata__record__content_type">Repository content <span style="color:red;">(s) *</span></label>
        <input type="text" name="register__metadata__record__content_type" value="{{', '.join(metadata.record.content_type)}}" class="ac"></p>
        
        <p><label for="register__metadata__record__certification">Repository certification <span style="color:red;">(s) *</span></label>
        <input type="text" name="register__metadata__record__certification" value="{{', '.join(metadata.record.certification)}}" class="ac"></p>
        
        <p><label for="register__metadata__record__subject__term">Repository subject <span style="color:red;">(s) *</span></label>
        <input type="text" name="register__metadata__record__subject__term" value="{{', '.join(metadata.record.subject.term)}}" class="ac"></p>
        
    </div>

</div>

</div>

{% endif %}

<!-- add templates in here for non-default metadata that can be looped to -->

{% endfor %}





<!-- organisations -->
<div id="organisation" class="row-fluid">
    <div class="span12">
        <div class="well banner odh">
            <h1>Organisational details</h1>
        </div>
    </div>
</div>

{% for org in record.register.organisation %}
<div class="row-fluid multidisplay organisation" style="border-bottom:1px solid #ccc;padding-bottom:10px;margin-bottom:10px;">

    <div class="span6">

        <p><label for="org_name">Name</label>
        <input type="text" name="org_name" value="{{org.details.name}}" class="acs"></p>

        <p><label for="org_acronym">Acronym</label>
        <input type="text" name="org_acronym" value="{{org.details.acronym}}"></p>

        <p><label for="org_unit">Org. Unit</label>
        <input type="text" name="org_unit" value="{{org.details.unit}}"></p>

        <p><label for="org_unit_acronym">Org. Unit Acronym</label>
        <input type="text" name="org_unit_acronym" value="{{org.details.unit_acronym}}"></p>

        <p><label for="org_unit_url">Org. Unit URL</label>
        <input type="text" name="org_unit_url" value="{{org.details.unit_url}}"></p>

    </div>
    
    <div class="span6">

        <p><label for="org_role">Role</label>
        <input type="text" name="org_role" value="{{org.role}}"></p>

        <p><label for="org_url">URL</label>
        <input type="text" name="org_url" value="{{org.details.url}}"></p>
<!--
        <p><label for="org_country">Country</label>
        <input type="text" name="org_country" value="{{org.details.country}}"></p>
-->
        <p><label for="org_country_code">Country Code</label>
        <input type="text" name="org_country_code" value="{{org.details.country_code}}" class="acs"></p>
    
        <p><label for="org_lat">Lat / lon</label>
        <input type="text" name="org_lat" value="{{org.details.lat}}" style="width:98px;">
        <input type="text" name="org_lon" value="{{org.details.lon}}" style="width:98px;"></p>

    </div>

</div>
{% endfor %}

<div class="row-fluid multi organisation" style="border-bottom:1px solid #ccc;padding-bottom:10px;margin-bottom:10px;">

    <div class="span6">

        <p><label for="org_name">Name</label>
        <input type="text" name="org_name" class="ac finder"></p>

        <p><label for="org_acronym">Acronym</label>
        <input type="text" name="org_acronym"></p>

        <p><label for="org_unit">Org. Unit</label>
        <input type="text" name="org_unit"></p>

        <p><label for="org_unit_acronym">Org. Unit Acronym</label>
        <input type="text" name="org_unit_acronym"></p>

        <p><label for="org_unit_url">Org. Unit URL</label>
        <input type="text" name="org_unit_url"></p>

    </div>
    
    <div class="span6">

        <p><label for="org_role">Role</label>
        <input type="text" name="org_role"></p>

        <p><label for="org_url">URL</label>
        <input type="text" name="org_url"></p>

        <p><label for="org_country">Country</label>
        <input type="text" name="org_country"></p>

        <p><label for="org_country_code">Country Code</label>
        <input type="text" name="org_country_code"></p>

        <p><label for="org_lat">Lat / lon</label>
        <input type="text" name="org_lat" style="width:98px;">
        <input type="text" name="org_lon" style="width:98px;"></p>

    </div>

</div>

<a class="btn btn-success addsection" href="#" data-type=".organisation">Add another organisation</a>





<!-- contacts -->
<div id="contact" class="row-fluid">
    <div class="span12">
        <div class="well banner odh">
            <h1>Contact details</h1>
        </div>
    </div>
</div>

{% for contact in record.register.contact %}
<div class="row-fluid multidisplay contact" style="border-bottom:1px solid #ccc;padding-bottom:10px;margin-bottom:10px;">

    <div class="span6">

        <p><label for="contact_name">Name</label>
        <input type="text" name="contact_name" value="{{contact.details.name}}" class="ac finder"></p>

        <p><label for="contact_job_title">Job title</label>
        <input type="text" name="contact_job_title" value="{{contact.details.job_title}}"></p>

        <p><label for="contact_email">Email</label>
        <input type="text" name="contact_email" value="{{contact.details.email}}"></p>

        <p><label for="contact_phone">Phone</label>
        <input type="text" name="contact_phone" value="{{contact.details.phone}}"></p>

        <p><label for="contact_fax">Fax</label>
        <input type="text" name="contact_fax" value="{{contact.details.fax}}"></p>

    </div>
    
    <div class="span6">

        <p><label for="contact_role">Role</label>
        <input type="text" name="contact_role" value="{{contact.role}}"></p>

        <p><label for="contact_address">Address</label>
        <textarea name="contact_address" style="height:110px;">{{contact.details.address}}</textarea></p>

        <p><label for="contact_lat">Lat / lon</label>
        <input type="text" name="contact_lat" value="{{contact.details.lat}}" style="width:98px;">
        <input type="text" name="contact_lon" value="{{contact.details.lon}}" style="width:98px;"></p>

    </div>

</div>
{% endfor %}

<div class="row-fluid multi contact" style="border-bottom:1px solid #ccc;padding-bottom:10px;margin-bottom:10px;">

    <div class="span6">

        <p><label for="contact_name">Name</label>
        <input type="text" name="contact_name" class="ac finder"></p>

        <p><label for="contact_job_title">Job title</label>
        <input type="text" name="contact_job_title"></p>

        <p><label for="contact_email">Email</label>
        <input type="text" name="contact_email"></p>

        <p><label for="contact_phone">Phone</label>
        <input type="text" name="contact_phone"></p>

        <p><label for="contact_fax">Fax</label>
        <input type="text" name="contact_fax"></p>

    </div>
    
    <div class="span6">

        <p><label for="contact_role">Role</label>
        <input type="text" name="contact_role"></p>

        <p><label for="contact_address">Address</label>
        <textarea name="contact_address" style="height:110px;"></textarea></p>

        <p><label for="contact_lat">Lat / lon</label>
        <input type="text" name="contact_lat" style="width:98px;">
        <input type="text" name="contact_lon" style="width:98px;"></p>

    </div>

</div>

<a class="btn btn-success addsection" href="#" data-type=".contact">Add another contact</a>








<!-- policy -->
<div id="policy" class="row-fluid">
    <div class="span12">
        <div class="well banner odh">
            <h1>Repository policies</h1>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">		
        <table class="multidisplay policy">
            <thead>
                <tr>
                    <th style="min-width:300px;">Type</th>
                    <th style="min-width:430px;">Description</th>
                    <th style="min-width:200px;">Terms</th>
                </tr>
            </thead>
            <tbody>
                {% for policy in record.register.policy %}
                <tr>
            		<td><input type="text" name="policy_policy_type" value="{{policy.policy_type}}"></td>
            		<td><textarea name="policy_description" style="height:18px;width:430px;">{{policy.description}}</textarea></td>
            		<td><input type="text" name="policy_terms" value="{{policy.terms}}"></td>            		
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="multi">
            <tbody>
                <tr>
            		<td><input type="text" name="policy_policy_type"></td>
            		<td><textarea name="policy_description" style="height:18px;width:430px;"></textarea></td>
            		<td><input type="text" name="policy_terms" class="needselect2"></td>            		
                </tr>
            </tbody>
        </table>        
    </div>
</div>






<!-- api -->
<div id="api" class="row-fluid">
    <div class="span12">
        <div class="well banner odh">
            <h1>Repository APIs</h1>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">		
        <table class="multidisplay policy">
            <thead>
                <tr>
                    <th style="min-width:200px;">Type</th>
                    <th style="min-width:100px;">Version</th>
                    <th style="min-width:200px;">Base URL</th>
                    <th style="min-width:200px;">Prefixes</th>
                    <th style="min-width:200px;">Accepts</th>
                    <th style="min-width:200px;">Packaging</th>
                </tr>
            </thead>
            <tbody>
                {% for api in record.register.api %}
                <tr>
            		<td><input type="text" name="api_api_type" value="{{api.api_type}}" style="width:100px;" class="ac"></td>
            		<td><input type="text" name="api_version" value="{{api.version}}" style="width:100px;"></td>            		
            		<td><input type="text" name="api_base_url" value="{{api.base_url}}"></td>            		
            		<td><input type="text" name="api_metadata_prefixes" value="{{api.metadata_prefixes}}"></td>
            		<td><input type="text" name="api_accepts" value="{{api.accepts}}"></td>            		
            		<td><input type="text" name="api_accept_packaging" value="{{api.accept_packaging}}"></td>            		
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="multi">
            <tbody>
                <tr>
            		<td><input type="text" name="api_api_type" style="width:100px;" class="ac"></td>
            		<td><input type="text" name="api_version" style="width:100px;"></td>            		
            		<td><input type="text" name="api_base_url" ></td>            		
            		<td><input type="text" name="api_metadata_prefixes"></td>
            		<td><input type="text" name="api_accepts"></td>            		
            		<td><input type="text" name="api_accept_packaging"></td>            		
                </tr>
            </tbody>
        </table>        
    </div>
</div>






<!-- software -->
<div id="software" class="row-fluid">
    <div class="span12">
        <div class="well banner odh">
            <h1>Software</h1>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">		
        <table class="multidisplay software">
            <thead>
                <tr>
                    <th style="min-width:300px;">Name</th>
                    <th style="min-width:200px;">Version</th>
                    <th style="min-width:200px;">URL</th>
                </tr>
            </thead>
            <tbody>
                {% for software in record.register.software %}
                <tr>
            		<td><input type="text" name="software_name" value="{{software.name}}" class="ac"></td>
            		<td><input type="text" name="software_version" value="{{software.version}}"></td>            		
            		<td><input type="text" name="software_url" value="{{software.url}}"></td>            		
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="multi">
            <tbody>
                <tr>
            		<td><input type="text" name="software_name" class="ac"></td>
            		<td><input type="text" name="software_version"></td>            		
            		<td><input type="text" name="software_url"></td>            		
                </tr>
            </tbody>
        </table>        
    </div>
</div>






<!-- integration -->
<div id="software" class="row-fluid">
    <div class="span12">
        <div class="well banner odh">
            <h1>Integration</h1>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div class="span12">		
        <table class="multidisplay integration">
            <thead>
                <tr>
                    <th style="min-width:300px;">With</th>
                    <th style="min-width:200px;">Nature</th>
                    <th style="min-width:200px;">URL</th>
                    <th style="min-width:200px;">Software</th>
                    <th style="min-width:200px;">Version</th>
                </tr>
            </thead>
            <tbody>
                {% for integration in record.register.integration %}
                <tr>
            		<td><input type="text" name="integration_integrated_with" value="{{integration.integrated_with}}"></td>
            		<td><input type="text" name="integration_nature" value="{{integration.nature}}"></td>            		
            		<td><input type="text" name="integration_url" value="{{integration.url}}"></td>            		
            		<td><input type="text" name="integration_software" value="{{integration.software}}"></td>            		
            		<td><input type="text" name="integration_version" value="{{integration.version}}"></td>            		
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="multi">
            <tbody>
                <tr>
            		<td><input type="text" name="integration_integrated_with"></td>
            		<td><input type="text" name="integration_nature"></td>            		
            		<td><input type="text" name="integration_url"></td>            		
            		<td><input type="text" name="integration_software"></td>            		
            		<td><input type="text" name="integration_version"></td>            		
                </tr>
            </tbody>
        </table>        
    </div>
</div>





<input type="submit" class="btn btn-info" style="width:100%;font-size:30px;line-height:30px;height:120px;margin-top:30px;" 
{% if current_user.is_super %}
value="Click here when ready to save this data to OpenDOAR"
{% else %}
value="Click here when ready to submit this repository data to OpenDOAR"
{% endif %}
>

{% if current_user.is_super and record.id %}
<p style="color:red;"><br>
<input type="submit" name="submit" value="Delete" class="btn btn-small btn-danger">
Or click the button to the left to delete this record. WANRING: Cannot be undone!</p>
{% endif %}

</form>

{% endblock %}




{% block extra_js_bottom %}

<script type="text/javascript">

jQuery(document).ready(function($) {

    // start with a detect by URL
    {% if not detectdone %}
    $('#form').hide();
    $('#sumeta').hide();
    $('#detect').show();
    $('#url').focus();
    {% endif %}

    // set datepickers
    var opts = {
        inline: true,
        dateFormat: 'dd/mm/yy',
        changeYear: true
    }
    $('.datepicker').datepicker(opts);
    
    // function of things to do whenever a row is appended
    var preprow = function(row) {
        $(row).find('.delete-row').bind('click',deleterow);
        $(row).find('select').val("");
        $(row).find('input').val("");
        $(row).find('textarea').html("");
        $(row).find('.datepicker').datepicker("destroy");
        $(row).find('.datepicker').removeClass("hasDatepicker").removeAttr('id');
        $(row).find('.datepicker').datepicker(opts);
    }

    // fit a static row remover for old content
    $('table.multidisplay').find('tbody').children('tr').each(function() {
        var adder = '<a class="btn btn-warning static-delete-row" style="margin:-10px 2px 0 0;" href="#">delete</a>';
        adder += '<a class="btn edit-row" style="margin:-10px 2px 0 0;';
        if ( !$(this).parents('table').hasClass('editablerows') ) { adder += 'visibility:hidden;'; }
        adder += '" href="#">edit</a>';
        $(this).children('td').first().prepend(adder).children('select, input').addClass('narrow');
    });
    var staticdeleterow = function(event) {
        event.preventDefault();
        var row = $(this).closest('tr').clone(true).get(0);
        $(this).closest('tr').remove();
    }
    $('.static-delete-row').bind('click',staticdeleterow);

    // add / remove rows to list items
    $('table.multi').find('tbody').children('tr').each(function() {
        $(this).children('td').first().prepend('<a class="btn btn-warning delete-row" href="#">delete</a>').children('select, input').addClass('narrow');
    });
    $('table.multi').find('tbody').append('<tr><td><a class="btn btn-success add-row" href="#">add</a></td></tr>');
    var addrow = function(event) {
        event.preventDefault();
        var maxrows = 50;
        $(this).closest('table').hasClass('manyrows') ? maxrows = 100 : false;
        $(this).closest('tr').siblings().length == (maxrows - 1) ? $(this).hide() : false;
        if ( $(this).closest('tr').siblings().length < maxrows ) {
            var row = $(this).closest('tr').prev().clone(true).get(0);
            $(row).find('.noclone').remove();
            $(row).insertBefore($(this).closest('tr'));
            preprow(row);
        }
    }
    $('.add-row').bind('click',addrow);
    var deleterow = function(event) {
        event.preventDefault();
        var row = $(this).closest('tr').clone(true).get(0);
        var maxrows = 50;
        $(this).closest('table').hasClass('manyrows') ? maxrows = 100 : false;
        $(this).closest('tr').siblings().length == maxrows ? $(this).closest('tr').siblings().find('.add-row').show() : false;
        if ( $(this).closest('tr').siblings().length == 1 ) {
            $(row).find('.noclone').remove();
            $(row).insertBefore($(this).closest('tr'));
            preprow(row);
        }
        $(this).closest('tr').remove();
    }
    $('.delete-row').bind('click',deleterow);


    var delbutton = '<a class="btn btn-warning delsection" href="#">Delete</a>';
    var delsection = function(event) {
        event.preventDefault();
        $(this).parent().remove();
    }
    $('.delsection').bind('click',delsection);
    var addsection = function(event) {
        event.preventDefault();
        var type = $(this).attr('data-type');
        var cloned = $(type).last().clone();
        $(type).last().append(delbutton);
        $(type).last().after(cloned);
        // add functions to the stuff inserted
        $('.delsection').unbind('click',delsection).bind('click',delsection);
    }
    $('.addsection').bind('click',addsection);
    
    
    var ac_url = '/stream/record/';
    $( ".ac" ).autocomplete({
      source: function( request, response ) {
        var terms = request.term.split( /,\s*/ );
        var t = $.trim(terms[terms.length-1]);
        $.ajax({
          url: ac_url + $(this.element).attr('name').replace(/__/g,'.') + '?q=' + t,
          cache:false,
          async:false,
          dataType: "json",
          type: 'GET',
          contentType: 'application/json',
          success: function( data ) {
            var res = [];
            for ( var r in data ) {
              if ( data[r].toLowerCase().indexOf(t.toLowerCase()) >= 0 ) {
                var tr = data[r];
                if ( tr.indexOf(',') >= 0 ) {
                  tr = '"' + tr + '"';
                }
                res.push(tr);
              }
            }
            response( res );
          }
        });
      },
      select: function( event, ui ) {
          var terms = this.value.split( /,\s*/ );
          terms.pop();
          terms.push( ui.item.value );
          terms.push( "" );
          this.value = terms.join( ", " );
          return false;
      },
      minLength: 0
    });

    $( ".acs" ).autocomplete({
      source: function( request, response ) {
        $.ajax({
          url: ac_url + $(this.element).attr('name').replace(/__/g,'.') + '?q=' + request.term,
          cache:false,
          async:false,
          dataType: "json",
          type: 'GET',
          contentType: 'application/json',
          success: function( data ) {
            var res = [];
            for ( var r in data ) {
              if ( data[r].toLowerCase().indexOf(request.term.toLowerCase()) >= 0 ) {
                var tr = data[r];
                if ( tr.indexOf(',') >= 0 ) {
                  tr = '"' + tr + '"';
                }
                res.push(tr);
              }
            }
            response( res );
          }
        });
      },
      minLength: 0
    });


    var dupwarning = function(did) {
        if ( did !== false ) {
            $('#dupid').attr("href",'/repository/' + did);
            $('#dupwarning').show();
        }
    }
    {% if duplicate and ( not record.id and detectdone ) %}
    dupwarning("{{duplicate}}");
    {% endif %}

    var dupcheck = function(event) {
        $.ajax({
          url: '/duplicate?url=' + $(this).val(),
          cache:false,
          async:false,
          dataType: "json",
          type: 'GET',
          contentType: 'application/json',
          success: dupwarning
        });
    }
    $('#url').bind('keyup',dupcheck);

})

</script>

{% endblock %}


